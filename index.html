<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proxy</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family: Arial,sans-serif; }
#topBar { background:#222; color:white; padding:5px 10px; display:flex; align-items:center; flex-wrap:wrap; }
#quickLinks { display:flex; gap:8px; margin-right:10px; }
#quickLinks button { padding:5px 8px; font-size:14px; cursor:pointer; }
#urlBar { flex:1; min-width:200px; max-width:300px; padding:3px; font-size:14px; }
#topBar button.control { margin-left:10px; padding:5px 10px; }
#iframeContainer { width:100%; height:calc(100% - 50px); }
#proxyFrame { width:100%; height:100%; border:none; }

/* Pop-up overlay */
#announcementPopup {
  display: none;
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#popupContent {
  background:white;
  padding:20px;
  border-radius:8px;
  max-width:400px;
  text-align:center;
  position: relative;
}

/* Banner */
#announcementBanner {
  display: none;
  position: fixed;
  top:0; left:0; right:0;
  background: #ffeb3b;
  color:#000;
  padding:10px 20px;
  font-weight:bold;
  z-index:1000;
}
#bannerClose {
  position:absolute;
  right:10px;
  top:5px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="topBar">
  <!-- Quick Links -->
  <div id="quickLinks">
    <button onclick="goQuick('https://google.com')">Google</button>
    <button onclick="goQuick('https://youtube.com')">YouTube</button>
    <button onclick="goQuick('https://github.com')">GitHub</button>
  </div>

  <!-- URL Bar -->
  <input type="text" id="urlBar" placeholder="Enter URL and press Enter">

  <!-- Controls -->
  <button class="control" onclick="toggleTopBar()">Show/Hide Bar</button>
  <button class="control" onclick="enterFullscreen()">Fullscreen</button>
</div>

<div id="iframeContainer">
  <iframe id="proxyFrame" src="https://example.com"></iframe>
</div>

<!-- Announcement Pop-up -->
<div id="announcementPopup">
  <div id="popupContent">
    <span id="popupText"></span>
    <div style="margin-top:10px;">
      <label><input type="checkbox" id="dontShow"> Don't show for next 5 sessions</label>
    </div>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<!-- Announcement Banner -->
<div id="announcementBanner">
  <span id="bannerText"></span>
  <span id="bannerClose" onclick="closeBanner()">X</span>
</div>

<script>
const iframe = document.getElementById('proxyFrame');
const urlBar = document.getElementById('urlBar');
const topBar = document.getElementById('topBar');

// Worker Proxy URL
const PROXY_URL = "https://proxy.cidler6901.workers.dev/?url=";

// Navigate iframe on Enter
urlBar.addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    let input = urlBar.value.trim();
    if(!input.startsWith("http://") && !input.startsWith("https://")){
      input = "https://" + input;
    }
    iframe.src = PROXY_URL + encodeURIComponent(input);
    hideTopBar();
  }
});

// Quick Links
function goQuick(url){
  iframe.src = PROXY_URL + encodeURIComponent(url);
  urlBar.value = url;
  hideTopBar();
}

function toggleTopBar() {
  if(topBar.style.display === 'none') topBar.style.display = 'flex';
  else topBar.style.display = 'none';
}
function hideTopBar() { topBar.style.display='none'; }
function showTopBar() { topBar.style.display='flex'; }

// Real browser fullscreen
function enterFullscreen() {
  const elem = document.documentElement;
  if (elem.requestFullscreen) {
    elem.requestFullscreen();
  } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
  else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
  hideTopBar();
}
document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement) {
    showTopBar();
  }
});

// Keep URL bar updated when iframe navigates
iframe.addEventListener("load", () => {
  try {
    const currentURL = iframe.contentWindow.location.href;
    // Strip proxy prefix if found
    if(currentURL.startsWith(PROXY_URL)){
      const decoded = decodeURIComponent(currentURL.replace(PROXY_URL,""));
      urlBar.value = decoded;
    } else {
      urlBar.value = currentURL;
    }
  } catch(err) {
    // Some pages block cross-origin, fallback to showing iframe.src
    if(iframe.src.startsWith(PROXY_URL)){
      urlBar.value = decodeURIComponent(iframe.src.replace(PROXY_URL,""));
    } else {
      urlBar.value = iframe.src;
    }
  }
});

// Announcement logic
function getSessionCount(){ return parseInt(localStorage.getItem('announcementSessions')||'0'); }
function incrementSessionCount(){ localStorage.setItem('announcementSessions', getSessionCount()+1); }
function resetSessionCount(){ localStorage.setItem('announcementSessions','0'); }

fetch("/api/announcement")
.then(res=>res.json())
.then(data=>{
  if(!data.enabled) return;
  const lastSHA = localStorage.getItem('announcementSHA');
  if(lastSHA !== data.sha){
    resetSessionCount();
    localStorage.setItem('announcementSHA', data.sha);
  }
  if(getSessionCount()<5) showPopup(data.announcement);
  showBanner(data.announcement);
});

function showPopup(text){
  document.getElementById('popupText').innerText = text;
  document.getElementById('announcementPopup').style.display='flex';
}
function closePopup(){
  if(document.getElementById('dontShow').checked) localStorage.setItem('announcementSessions','5');
  document.getElementById('announcementPopup').style.display='none';
  incrementSessionCount();
}
function showBanner(text){
  document.getElementById('announcementBanner').style.display='block';
  document.getElementById('bannerText').innerText = text;
}
function closeBanner(){ document.getElementById('announcementBanner').style.display='none'; }
</script>
</body>
</html>
